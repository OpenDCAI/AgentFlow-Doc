import{_ as n,c as a,a as e,o as i}from"./app-BSBZkIGC.js";const l={};function p(d,s){return i(),a("div",null,[...s[0]||(s[0]=[e(`<p>本文介绍 AgentFlow 的整体架构设计。AgentFlow 由三大核心模块组成：<strong>Synthesis（数据合成）</strong>、<strong>Rollout（推理评测）</strong> 和 <strong>Sandbox（沙箱环境）</strong>。三者协同工作，构成完整的 Agent 数据合成与评测框架。</p><h2 id="整体架构图" tabindex="-1"><a class="header-anchor" href="#整体架构图"><span>整体架构图</span></a></h2><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span>┌─────────────────────────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│                        AgentFlow 统一框架                                    │</span></span>
<span class="line"><span>├──────────────────────┬──────────────────────┬───────────────────────────────┤</span></span>
<span class="line"><span>│                      │                      │                               │</span></span>
<span class="line"><span>│  ┌────────────────┐  │  ┌────────────────┐  │  ┌─────────────────────────┐  │</span></span>
<span class="line"><span>│  │   Synthesis    │  │  │    Rollout     │  │  │        Sandbox          │  │</span></span>
<span class="line"><span>│  │   (数据合成)    │  │  │   (推理评测)   │  │  │      (沙箱环境)         │  │</span></span>
<span class="line"><span>│  ├────────────────┤  │  ├────────────────┤  │  ├─────────────────────────┤  │</span></span>
<span class="line"><span>│  │                │  │  │                │  │  │                         │  │</span></span>
<span class="line"><span>│  │ SynthesisPipe- │  │  │ RolloutPipe-   │  │  │  Sandbox (Facade)      │  │</span></span>
<span class="line"><span>│  │ line           │  │  │ line           │  │  │    │                    │  │</span></span>
<span class="line"><span>│  │   │            │  │  │   │            │  │  │    ▼                    │  │</span></span>
<span class="line"><span>│  ���   ├─Trajectory │  │  │   ├─AgentRunner│  │  │  HTTPServiceClient     │  │</span></span>
<span class="line"><span>│  │   │  Sampler   │  │  │   │            │  │  │    │                    │  │</span></span>
<span class="line"><span>│  │   │            │  │  │   ├─Evaluator  │  │  │    │ HTTP/JSON          │  │</span></span>
<span class="line"><span>│  │   ├─Trajectory │  │  │   │            │  │  │    ▼                    │  │</span></span>
<span class="line"><span>│  │   │  Selector  │  │  │   └─TaskResult │  │  │  HTTPServiceServer     │  │</span></span>
<span class="line"><span>│  │   │            │  │  │                │  │  │    │                    │  │</span></span>
<span class="line"><span>│  │   └─QA         │  │  │                │  │  │    ├─ToolExecutor      │  │</span></span>
<span class="line"><span>│  │     Synthesizer│  │  │                │  │  │    ├─ResourceRouter     │  │</span></span>
<span class="line"><span>│  │                │  │  │                │  │  │    │                    │  │</span></span>
<span class="line"><span>│  └───────┬────────┘  │  └───────┬────────┘  │  │    ▼                    │  │</span></span>
<span class="line"><span>│          │           │          │           │  │  Backend System         │  │</span></span>
<span class="line"><span>│          │           │          │           │  │  ┌─���─┬───┬───┬───┬───┐  │  │</span></span>
<span class="line"><span>│          │           │          │           │  │  │VM │RAG│Bsh│Brw│Cod│  │  │</span></span>
<span class="line"><span>│          ▼           │          ▼           │  │  └───┴───┴───┴───┴───┘  │  │</span></span>
<span class="line"><span>│     Sandbox API      │     Sandbox API      │  │  ┌─────────────────┐    │  │</span></span>
<span class="line"><span>│                      │                      │  │  │  API Tools      │    │  │</span></span>
<span class="line"><span>│                      │                      │  │  │  (WebSearch...) │    │  │</span></span>
<span class="line"><span>│                      │                      │  │  └─────────────────┘    │  │</span></span>
<span class="line"><span>│                      │                      │  └─────────────────────────┘  │</span></span>
<span class="line"><span>└──────────────────────┴──────────────────────┴───────────────────────────────┘</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Synthesis 和 Rollout 模块均通过 Sandbox 提供的统一 API 与底层工具和环境交互。</p><h2 id="模块一-synthesis-数据合成" tabindex="-1"><a class="header-anchor" href="#模块一-synthesis-数据合成"><span>模块一：Synthesis（数据合成）</span></a></h2><h3 id="组件说明" tabindex="-1"><a class="header-anchor" href="#组件说明"><span>组件说明</span></a></h3><table><thead><tr><th>组件</th><th>位置</th><th>职责</th></tr></thead><tbody><tr><td><strong>SynthesisPipeline</strong></td><td><code>synthesis/pipeline.py</code></td><td>主流水线，编排三个阶段的执行流程</td></tr><tr><td><strong>SynthesisConfig</strong></td><td><code>synthesis/core/config.py</code></td><td>合成配置管理，支持 JSON/YAML 加载</td></tr><tr><td><strong>TrajectorySampler</strong></td><td><code>synthesis/core/sampler.py</code></td><td>轨迹采样器，LLM 驱动的环境探索与轨迹树构建</td></tr><tr><td><strong>TrajectorySelector</strong></td><td><code>synthesis/core/selector.py</code></td><td>轨迹选择器，按深度、信息丰富度、工具多样性评分筛选</td></tr><tr><td><strong>QASynthesizer</strong></td><td><code>synthesis/core/synthesizer.py</code></td><td>QA 合成器，基于轨迹生成多跳事实型 QA 对</td></tr><tr><td><strong>SandboxWorker</strong></td><td><code>synthesis/core/worker.py</code></td><td>Sandbox 工作单元，封装与沙箱环境的交互</td></tr><tr><td><strong>synthesize()</strong></td><td><code>synthesis/api.py</code></td><td>一行调用入口函数</td></tr></tbody></table><h3 id="数据合成流水线" tabindex="-1"><a class="header-anchor" href="#数据合成流水线"><span>数据合成流水线</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span>Seeds (种子数据)</span></span>
<span class="line"><span>  │</span></span>
<span class="line"><span>  │  从 JSONL 文件或列表加载</span></span>
<span class="line"><span>  ▼</span></span>
<span class="line"><span>┌──────────────────────────────────┐</span></span>
<span class="line"><span>│     TrajectorySampler            │</span></span>
<span class="line"><span>│                                  │</span></span>
<span class="line"><span>│  对每个 Seed:                     │</span></span>
<span class="line"><span>│  1. 初始化 Sandbox Session       │</span></span>
<span class="line"><span>│  2. LLM 提出工具调用              │</span></span>
<span class="line"><span>│  3. 在 Sandbox 中执行工具         │</span></span>
<span class="line"><span>│  4. 记录观测结果                  │</span></span>
<span class="line"><span>│  5. 构建分支轨迹树                │</span></span>
<span class="line"><span>│     (并发扩展 + 动作去重)          │</span></span>
<span class="line"><span>│                                  │</span></span>
<span class="line"><span>│  配置: max_depth, branching_factor│</span></span>
<span class="line"><span>└──────────┬───────────────────────┘</span></span>
<span class="line"><span>           │</span></span>
<span class="line"><span>           │  轨迹树 (Dict[str, TrajectoryNode])</span></span>
<span class="line"><span>           ▼</span></span>
<span class="line"><span>┌──────────────────────────────────┐</span></span>
<span class="line"><span>│     TrajectorySelector           │</span></span>
<span class="line"><span>│                                  │</span></span>
<span class="line"><span>│  1. 查找所有叶节点                │</span></span>
<span class="line"><span>│  2. 按 min_depth 过滤             │</span></span>
<span class="line"><span>│  3. 构建根到叶路径                │</span></span>
<span class="line"><span>│  4. 多维评分:                     │</span></span>
<span class="line"><span>│     - 路径深度                    │</span></span>
<span class="line"><span>│     - 信息丰富度                  │</span></span>
<span class="line"><span>│     - 工具多样性                  │</span></span>
<span class="line"><span>│  5. 相似度去重                    │</span></span>
<span class="line"><span>│  6. 选择 top-k 轨迹              │</span></span>
<span class="line"><span>│                                  │</span></span>
<span class="line"><span>│  配置: min_depth, max_selected_traj│</span></span>
<span class="line"><span>│        path_similarity_threshold  │</span></span>
<span class="line"><span>└──────────┬───────────────────────┘</span></span>
<span class="line"><span>           │</span></span>
<span class="line"><span>           │  List[Trajectory]</span></span>
<span class="line"><span>           ▼</span></span>
<span class="line"><span>┌──────────────────────────────────┐</span></span>
<span class="line"><span>│     QASynthesizer                │</span></span>
<span class="line"><span>│                                  │</span></span>
<span class="line"><span>│  对每条轨迹:                      │</span></span>
<span class="line"><span>│  1. 格式化轨迹描述                │</span></span>
<span class="line"><span>│  2. 构建 LLM Prompt              │</span></span>
<span class="line"><span>│  3. 调用 LLM 生成 QA 对          │</span></span>
<span class="line"><span>│  4. 内置质量校验                  │</span></span>
<span class="line"><span>│  5. 失败重试 (最多 3 次)          │</span></span>
<span class="line"><span>│                                  │</span></span>
<span class="line"><span>│  输出: SynthesizedQA             │</span></span>
<span class="line"><span>└──────────┬───────────────────────┘</span></span>
<span class="line"><span>           │</span></span>
<span class="line"><span>           ▼</span></span>
<span class="line"><span>  QA Data (合成的 QA 数据)</span></span>
<span class="line"><span>  输出文件:</span></span>
<span class="line"><span>    - synthesized_qa.jsonl</span></span>
<span class="line"><span>    - trajectories.jsonl</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="模块二-rollout-推理评测" tabindex="-1"><a class="header-anchor" href="#模块二-rollout-推理评测"><span>模块二：Rollout（推理评测）</span></a></h2><h3 id="组件说明-1" tabindex="-1"><a class="header-anchor" href="#组件说明-1"><span>组件说明</span></a></h3><table><thead><tr><th>组件</th><th>位置</th><th>职责</th></tr></thead><tbody><tr><td><strong>RolloutPipeline</strong></td><td><code>rollout/pipeline.py</code></td><td>主流水线，编排 Benchmark 推理与评估</td></tr><tr><td><strong>RolloutConfig</strong></td><td><code>rollout/core/config.py</code></td><td>推理评测配置管理，支持 JSON/YAML</td></tr><tr><td><strong>AgentRunner</strong></td><td><code>rollout/core/runner.py</code></td><td>Agent 执行器，管理 LLM 对话循环和工具调用</td></tr><tr><td><strong>Evaluator</strong></td><td><code>rollout/core/evaluator.py</code></td><td>评估器，支持多种评测指标</td></tr><tr><td><strong>BenchmarkItem</strong></td><td><code>rollout/core/models.py</code></td><td>Benchmark 任务数据模型</td></tr><tr><td><strong>TaskResult</strong></td><td><code>rollout/core/models.py</code></td><td>任务执行结果数据模型</td></tr><tr><td><strong>RolloutSummary</strong></td><td><code>rollout/core/models.py</code></td><td>运行摘要数据模型</td></tr><tr><td><strong>rollout()</strong></td><td><code>rollout/api.py</code></td><td>一行调用入口函数</td></tr><tr><td><strong>quick_rollout()</strong></td><td><code>rollout/api.py</code></td><td>单问题快速推理函数</td></tr></tbody></table><h3 id="推理评测流水线" tabindex="-1"><a class="header-anchor" href="#推理评测流水线"><span>推理评测流水线</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span>Benchmark (评测数据集)</span></span>
<span class="line"><span>  │</span></span>
<span class="line"><span>  │  从 JSONL/JSON 文件加载</span></span>
<span class="line"><span>  │  可选: 限制任务数 (max_tasks)</span></span>
<span class="line"><span>  │        指定任务 ID (task_ids)</span></span>
<span class="line"><span>  ▼</span></span>
<span class="line"><span>┌──────────────────────────────────┐</span></span>
<span class="line"><span>│     RolloutPipeline              │</span></span>
<span class="line"><span>│                                  │</span></span>
<span class="line"><span>│  1. 加载 RolloutConfig           │</span></span>
<span class="line"><span>│  2. 验证配置                      │</span></span>
<span class="line"><span>│  3. 初始化输出文件                │</span></span>
<span class="line"><span>│  4. 创建 AgentRunner             │</span></span>
<span class="line"><span>│  5. 分配任务 (顺序/并行)          │</span></span>
<span class="line"><span>│                                  │</span></span>
<span class="line"><span>│  配置: max_workers, parallel      │</span></span>
<span class="line"><span>└──────────┬───────────────────────┘</span></span>
<span class="line"><span>           │</span></span>
<span class="line"><span>           │  List[BenchmarkItem]</span></span>
<span class="line"><span>           ▼</span></span>
<span class="line"><span>┌──────────────────────────────────┐</span></span>
<span class="line"><span>│     AgentRunner                  │</span></span>
<span class="line"><span>│                                  │</span></span>
<span class="line"><span>│  对每个 BenchmarkItem:            │</span></span>
<span class="line"><span>│  1. 连接 Sandbox                 │</span></span>
<span class="line"><span>│  2. 初始化 LLM 对话              │</span></span>
<span class="line"><span>│  3. 对话循环:                     │</span></span>
<span class="line"><span>│     a. LLM 生成回复/工具调用      │</span></span>
<span class="line"><span>│     b. 在 Sandbox 中执行工具      │</span></span>
<span class="line"><span>│     c. 将观测结果反馈给 LLM       │</span></span>
<span class="line"><span>│     d. 重复直至得到答案或达到上限  │</span></span>
<span class="line"><span>│  4. 提取预测答案                  │</span></span>
<span class="line"><span>│  5. 记录完整轨迹                  │</span></span>
<span class="line"><span>│                                  │</span></span>
<span class="line"><span>│  配置: max_turns, max_retries     │</span></span>
<span class="line"><span>│        system_prompt, model_name  │</span></span>
<span class="line"><span>└──────────┬───────────────────────┘</span></span>
<span class="line"><span>           │</span></span>
<span class="line"><span>           │  List[TaskResult]</span></span>
<span class="line"><span>           ▼</span></span>
<span class="line"><span>┌──────────────────────────────────┐</span></span>
<span class="line"><span>│     Evaluator                    │</span></span>
<span class="line"><span>│                                  │</span></span>
<span class="line"><span>│  对每个 TaskResult:               │</span></span>
<span class="line"><span>│  对比预测答案与标准答案:           │</span></span>
<span class="line"><span>│                                  │</span></span>
<span class="line"><span>│  支持的评测指标:                   │</span></span>
<span class="line"><span>│  - exact_match: 精确匹配          │</span></span>
<span class="line"><span>│  - f1_score: Token 级 F1 分数     │</span></span>
<span class="line"><span>│  - contains_answer: 包含答案      │</span></span>
<span class="line"><span>│  - numeric_match: 数值比较        │</span></span>
<span class="line"><span>│  - similarity: 语义相似度         │</span></span>
<span class="line"><span>│  - llm_judgement: LLM 评判        │</span></span>
<span class="line"><span>│                                  │</span></span>
<span class="line"><span>│  配置: evaluation_metric          │</span></span>
<span class="line"><span>│        evaluator_model_name       │</span></span>
<span class="line"><span>└──────────┬───────────────────────┘</span></span>
<span class="line"><span>           │</span></span>
<span class="line"><span>           ▼</span></span>
<span class="line"><span>  Results (评测结果)</span></span>
<span class="line"><span>  输出文件:</span></span>
<span class="line"><span>    - results_&lt;benchmark&gt;_&lt;timestamp&gt;.jsonl</span></span>
<span class="line"><span>    - evaluation_&lt;benchmark&gt;_&lt;timestamp&gt;.json</span></span>
<span class="line"><span>    - summary_&lt;benchmark&gt;_&lt;timestamp&gt;.json</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="模块三-sandbox-沙箱环境" tabindex="-1"><a class="header-anchor" href="#模块三-sandbox-沙箱环境"><span>模块三：Sandbox（沙箱环境）</span></a></h2><h3 id="组件说明-2" tabindex="-1"><a class="header-anchor" href="#组件说明-2"><span>组件说明</span></a></h3><table><thead><tr><th>组件</th><th>位置</th><th>职责</th></tr></thead><tbody><tr><td><strong>Sandbox</strong></td><td><code>sandbox/sandbox.py</code></td><td>用户门面类，提供统一的调用接口</td></tr><tr><td><strong>SandboxConfig</strong></td><td><code>sandbox/sandbox.py</code></td><td>Sandbox 配置，包含服务连接参数</td></tr><tr><td><strong>HTTPServiceClient</strong></td><td><code>sandbox/client.py</code></td><td>HTTP 客户端，封装请求与错误处理</td></tr><tr><td><strong>HTTPServiceServer</strong></td><td><code>sandbox/server/app.py</code></td><td>HTTP 服务器（FastAPI），持有工具映射和 Backend 实例</td></tr><tr><td><strong>ToolExecutor</strong></td><td><code>sandbox/server/core/tool_executor.py</code></td><td>工具执行器，路由解析、Session 注入、工具调用</td></tr><tr><td><strong>ResourceRouter</strong></td><td><code>sandbox/server/core/resource_router.py</code></td><td>资源路由器，Session 生命周期、Worker 资源隔离</td></tr><tr><td><strong>Backend</strong></td><td><code>sandbox/server/backends/base.py</code></td><td>后端基类，定义 warmup/initialize/cleanup/shutdown 接口</td></tr></tbody></table><h3 id="sandbox-执行流程" tabindex="-1"><a class="header-anchor" href="#sandbox-执行流程"><span>Sandbox 执行流程</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span>用户代码 / Synthesis / Rollout</span></span>
<span class="line"><span>  │</span></span>
<span class="line"><span>  │ sandbox.execute(&quot;vm:screenshot&quot;, {})</span></span>
<span class="line"><span>  ▼</span></span>
<span class="line"><span>Sandbox.execute()</span></span>
<span class="line"><span>  │</span></span>
<span class="line"><span>  │ await client.execute()</span></span>
<span class="line"><span>  ▼</span></span>
<span class="line"><span>HTTPServiceClient</span></span>
<span class="line"><span>  │</span></span>
<span class="line"><span>  │ POST /execute { worker_id, action, params }</span></span>
<span class="line"><span>  ▼</span></span>
<span class="line"><span>HTTPServiceServer (routes.py)</span></span>
<span class="line"><span>  │</span></span>
<span class="line"><span>  │ await server.execute()</span></span>
<span class="line"><span>  ▼</span></span>
<span class="line"><span>ToolExecutor.execute()</span></span>
<span class="line"><span>  │</span></span>
<span class="line"><span>  │ 1. 解析: &quot;vm:screenshot&quot; -&gt; resource_type=&quot;vm&quot;, tool=&quot;screenshot&quot;</span></span>
<span class="line"><span>  │ 2. 查找工具函数 (三层映射)</span></span>
<span class="line"><span>  │ 3. 获取/创建 Session (ResourceRouter)</span></span>
<span class="line"><span>  │ 4. 注入参数 (session, params)</span></span>
<span class="line"><span>  │ 5. 调用后端工具函数</span></span>
<span class="line"><span>  │ 6. 临时 Session 自动销毁</span></span>
<span class="line"><span>  ▼</span></span>
<span class="line"><span>返回结果 { status, data, meta }</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="backend-系统架构" tabindex="-1"><a class="header-anchor" href="#backend-系统架构"><span>Backend 系统架构</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span>Backend System</span></span>
<span class="line"><span>├── Resources (重量级后端, 需要 Session)</span></span>
<span class="line"><span>│   ├── VMBackend          - 虚拟机桌面自动化</span></span>
<span class="line"><span>│   │   └── 工具: screenshot, click, type, scroll, ...</span></span>
<span class="line"><span>│   ├── RAGBackend         - 文档检索服务</span></span>
<span class="line"><span>│   │   └── 工具: search, lookup, ...</span></span>
<span class="line"><span>│   ├── BashBackend        - 命令行交互</span></span>
<span class="line"><span>│   │   └── 工具: execute, ...</span></span>
<span class="line"><span>│   ├── BrowserBackend     - 网页自动化</span></span>
<span class="line"><span>│   │   └── 工具: navigate, click, extract, ...</span></span>
<span class="line"><span>│   └── CodeExecutorBackend - 代码沙箱执行</span></span>
<span class="line"><span>│       └── 工具: execute, ...</span></span>
<span class="line"><span>│</span></span>
<span class="line"><span>└── API Tools (轻量级工具, 无需 Session)</span></span>
<span class="line"><span>    ├── WebSearch          - 网络搜索</span></span>
<span class="line"><span>    ├── Text2SQL Tool      - SQL 查询</span></span>
<span class="line"><span>    ├── Doc Tool           - 文档处理</span></span>
<span class="line"><span>    └── DS Tool            - 数据科学</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="生命周期管理" tabindex="-1"><a class="header-anchor" href="#生命周期管理"><span>生命周期管理</span></a></h2><h3 id="backend-生命周期方法" tabindex="-1"><a class="header-anchor" href="#backend-生命周期方法"><span>Backend 生命周期方法</span></a></h3><table><thead><tr><th>方法</th><th>调用时机</th><th>作用</th><th>适用范围</th></tr></thead><tbody><tr><td><code>warmup()</code></td><td>服务器启动或显式调用</td><td>预热共享资源（如加载模型、建立连接池）</td><td>全局一次</td></tr><tr><td><code>initialize()</code></td><td>创建 Session</td><td>为指定 Worker 分配专属资源</td><td>每个 Worker</td></tr><tr><td><code>cleanup()</code></td><td>销毁 Session</td><td>回收 Worker 专属资源</td><td>每个 Worker</td></tr><tr><td><code>shutdown()</code></td><td>服务器关闭</td><td>释放所有共享资源</td><td>全局一次</td></tr></tbody></table><h3 id="sandbox-api-与-backend-生命周期对应" tabindex="-1"><a class="header-anchor" href="#sandbox-api-与-backend-生命周期对应"><span>Sandbox API 与 Backend 生命周期对应</span></a></h3><table><thead><tr><th>Sandbox API</th><th>Backend 方法</th><th>说明</th></tr></thead><tbody><tr><td><code>start()</code></td><td><code>warmup()</code></td><td>启动服务器，可选预热后端</td></tr><tr><td><code>warmup(resources)</code></td><td><code>warmup()</code></td><td>显式预热指定后端</td></tr><tr><td><code>create_session(type, config)</code></td><td><code>initialize()</code></td><td>创建 Session，分配 Worker 资源</td></tr><tr><td><code>execute(action, params)</code></td><td>工具函数</td><td>执行工具调用</td></tr><tr><td><code>destroy_session(type)</code></td><td><code>cleanup()</code></td><td>销毁 Session，回收 Worker 资源</td></tr><tr><td><code>shutdown_server()</code></td><td><code>shutdown()</code></td><td>关闭服务器，释放全部资源</td></tr></tbody></table><h2 id="模块间协作" tabindex="-1"><a class="header-anchor" href="#模块间协作"><span>模块间协作</span></a></h2><p>Synthesis 和 Rollout 模块通过 Sandbox 提供的统一接口与底层环境交互，其协作关系如下：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span>┌──────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│                    Synthesis 模块                         │</span></span>
<span class="line"><span>│                                                          │</span></span>
<span class="line"><span>│  SynthesisPipeline                                       │</span></span>
<span class="line"><span>│    └─ SandboxWorker ──┐                                  │</span></span>
<span class="line"><span>│         │              │                                 │</span></span>
<span class="line"><span>│  TrajectorySampler     │                                 │</span></span>
<span class="line"><span>│    └─ 调用 Sandbox     │   Sandbox API                   │</span></span>
<span class="line"><span>│       execute()        ├─────────────────┐               │</span></span>
<span class="line"><span>│                        │                 │               │</span></span>
<span class="line"><span>└────────────────────────┘                 │               │</span></span>
<span class="line"><span>                                           ▼               │</span></span>
<span class="line"><span>                                 ┌──────────────────┐      │</span></span>
<span class="line"><span>                                 │     Sandbox      │      │</span></span>
<span class="line"><span>                                 │                  │      │</span></span>
<span class="line"><span>                                 │  create_session()│      │</span></span>
<span class="line"><span>                                 │  execute()       │      │</span></span>
<span class="line"><span>                                 │  destroy_session()│     │</span></span>
<span class="line"><span>                                 │                  │      │</span></span>
<span class="line"><span>                                 └──────────────────┘      │</span></span>
<span class="line"><span>                                           ▲               │</span></span>
<span class="line"><span>┌────────────────────────┐                 │               │</span></span>
<span class="line"><span>│                        │                 │               │</span></span>
<span class="line"><span>│  RolloutPipeline       │   Sandbox API   │               │</span></span>
<span class="line"><span>│    └─ AgentRunner ─────┼─────────────────┘               │</span></span>
<span class="line"><span>│         │              │                                 │</span></span>
<span class="line"><span>│  Evaluator             │                                 │</span></span>
<span class="line"><span>│    └─ 评估结果          │                                 │</span></span>
<span class="line"><span>│                        │                                 │</span></span>
<span class="line"><span>│                    Rollout 模块                           │</span></span>
<span class="line"><span>└──────────────────────────────────────────────────────────┘</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="配置体系" tabindex="-1"><a class="header-anchor" href="#配置体系"><span>配置体系</span></a></h2><p>三大模块各自拥有独立的配置类，均支持 JSON 和 YAML 格式加载：</p><table><thead><tr><th>模块</th><th>配置类</th><th>配置路径</th><th>核心配置项</th></tr></thead><tbody><tr><td>Synthesis</td><td><code>SynthesisConfig</code></td><td><code>configs/synthesis/</code></td><td>seeds_file, max_depth, branching_factor, available_tools</td></tr><tr><td>Rollout</td><td><code>RolloutConfig</code></td><td><code>configs/trajectory/</code>, <code>configs/infer/</code></td><td>data_path, max_turns, evaluation_metric, max_workers</td></tr><tr><td>Sandbox</td><td>服务端 JSON 配置</td><td><code>configs/sandbox-server/</code></td><td>resources, apis, server (host, port, session_ttl)</td></tr></tbody></table><p>所有模块均通过以下参数连接 Sandbox：</p><table><thead><tr><th>参数</th><th>说明</th><th>默认值</th></tr></thead><tbody><tr><td><code>sandbox_server_url</code></td><td>Sandbox 服务器地址</td><td><code>http://127.0.0.1:18890</code></td></tr><tr><td><code>sandbox_auto_start</code></td><td>是否自动启动服务器</td><td>Synthesis: <code>true</code>, Rollout: <code>false</code></td></tr><tr><td><code>sandbox_config_path</code></td><td>Sandbox 配置文件路径</td><td><code>None</code></td></tr><tr><td><code>sandbox_timeout</code></td><td>Sandbox 请求超时（秒）</td><td><code>120</code></td></tr></tbody></table><h2 id="项目结构" tabindex="-1"><a class="header-anchor" href="#项目结构"><span>项目结构</span></a></h2><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span>AgentFlow/</span></span>
<span class="line"><span>├── synthesis/                    # 数据合成模块</span></span>
<span class="line"><span>│   ├── __init__.py</span></span>
<span class="line"><span>│   ├── api.py                    # 公开 API (synthesize, load_config, load_seeds)</span></span>
<span class="line"><span>│   ├── pipeline.py               # SynthesisPipeline 主流水线</span></span>
<span class="line"><span>│   └── core/</span></span>
<span class="line"><span>│       ├── __init__.py</span></span>
<span class="line"><span>│       ├── config.py             # SynthesisConfig 配置管理</span></span>
<span class="line"><span>│       ├── sampler.py            # TrajectorySampler 轨迹采样器</span></span>
<span class="line"><span>│       ├── selector.py           # TrajectorySelector 轨迹选择器</span></span>
<span class="line"><span>│       ├── synthesizer.py        # QASynthesizer QA 合成器</span></span>
<span class="line"><span>│       ├── worker.py             # SandboxWorker 沙箱工作单元</span></span>
<span class="line"><span>│       ├── models.py             # 数据模型 (TrajectoryNode, Trajectory, SynthesizedQA)</span></span>
<span class="line"><span>│       └── utils.py              # 工具函数</span></span>
<span class="line"><span>│</span></span>
<span class="line"><span>├── rollout/                      # 推理评测模块</span></span>
<span class="line"><span>│   ├── __init__.py</span></span>
<span class="line"><span>│   ├── api.py                    # 公开 API (rollout, quick_rollout)</span></span>
<span class="line"><span>│   ├── pipeline.py               # RolloutPipeline 主流水线</span></span>
<span class="line"><span>│   ├── core/</span></span>
<span class="line"><span>│   │   ├── __init__.py</span></span>
<span class="line"><span>│   │   ├── config.py             # RolloutConfig 配置管理</span></span>
<span class="line"><span>│   │   ├── runner.py             # AgentRunner Agent 执行器</span></span>
<span class="line"><span>│   │   ├── evaluator.py          # Evaluator 评估器</span></span>
<span class="line"><span>│   │   ├── models.py             # 数据模型 (BenchmarkItem, TaskResult, RolloutSummary)</span></span>
<span class="line"><span>│   │   └── utils.py              # 工具函数</span></span>
<span class="line"><span>│   └── tests/                    # 单元测试</span></span>
<span class="line"><span>│       ├── test_config.py</span></span>
<span class="line"><span>│       ├── test_evaluator.py</span></span>
<span class="line"><span>│       ├── test_models.py</span></span>
<span class="line"><span>│       └── test_integration.py</span></span>
<span class="line"><span>│</span></span>
<span class="line"><span>├── sandbox/                      # 沙箱环境模块</span></span>
<span class="line"><span>│   ├── __init__.py               # 模块导出</span></span>
<span class="line"><span>│   ├── sandbox.py                # Sandbox 用户门面类</span></span>
<span class="line"><span>│   ├── client.py                 # HTTPServiceClient HTTP 客户端</span></span>
<span class="line"><span>│   ├── tool_schemas/             # 工具 Schema 定义</span></span>
<span class="line"><span>│   │</span></span>
<span class="line"><span>│   ├── server/                   # 服务器模块</span></span>
<span class="line"><span>│   │   ├── app.py                # HTTPServiceServer (FastAPI)</span></span>
<span class="line"><span>│   │   ├── routes.py             # HTTP 路由定义</span></span>
<span class="line"><span>│   │   ├── config_loader.py      # 配置加载器</span></span>
<span class="line"><span>│   │   │</span></span>
<span class="line"><span>│   │   ├── core/                 # 核心组件</span></span>
<span class="line"><span>│   │   │   ├── decorators.py     # @tool 装饰器</span></span>
<span class="line"><span>│   │   │   ├── tool_executor.py  # ToolExecutor 工具执行器</span></span>
<span class="line"><span>│   │   │   └── resource_router.py # ResourceRouter 资源路由器</span></span>
<span class="line"><span>│   │   │</span></span>
<span class="line"><span>│   │   └── backends/             # 后端实现</span></span>
<span class="line"><span>│   │       ├── base.py           # Backend 基类</span></span>
<span class="line"><span>│   │       ├── resources/        # 重量级后端 (VM, RAG, Bash, Browser, Code)</span></span>
<span class="line"><span>│   │       └── tools/            # 轻量级 API 工具 (WebSearch, Text2SQL, ...)</span></span>
<span class="line"><span>│   │</span></span>
<span class="line"><span>│   └── configs/                  # 配置文件</span></span>
<span class="line"><span>│</span></span>
<span class="line"><span>└── configs/                      # 全局配置目录</span></span>
<span class="line"><span>    ├── sandbox-server/           # Sandbox 服务器配置</span></span>
<span class="line"><span>    ├── synthesis/                # 数据合成配置</span></span>
<span class="line"><span>    ├── trajectory/               # 轨迹推理配置</span></span>
<span class="line"><span>    └── infer/                    # 模型推理配置</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,36)])])}const t=n(l,[["render",p]]),r=JSON.parse('{"path":"/zh/guide/architecture/","title":"架构设计","lang":"zh-CN","frontmatter":{"title":"架构设计","createTime":"2025/02/04 10:00:00","icon":"material-symbols:auto-transmission-sharp","permalink":"/zh/guide/architecture/"},"readingTime":{"minutes":6.23,"words":1870},"git":{"createdTime":1770210864000,"updatedTime":1771412123000,"contributors":[{"name":"Jialong Wu","username":"","email":"jialong@JialongdeMacBook-Air.local","commits":1,"avatar":"https://gravatar.com/avatar/8b13955affa5cc83f8d0e72a08fcc5919d691747e429237ed1c21a8405ed8f19?d=retro"},{"name":"callanwu","username":"callanwu","email":"wujialongml@gmail.com","commits":1,"avatar":"https://avatars.githubusercontent.com/callanwu?v=4","url":"https://github.com/callanwu"},{"name":"Claude Opus 4.6","username":"","email":"noreply@anthropic.com","commits":1,"avatar":"https://gravatar.com/avatar/cd29c5ac348a026a3ec5286890908fffb5bf6ab77f20672171be323a70c95026?d=retro"}]},"filePathRelative":"zh/notes/guide/basicinfo/architecture.md","headers":[]}');export{t as comp,r as data};
